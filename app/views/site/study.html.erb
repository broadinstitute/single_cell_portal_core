<h1 class="study-lead">Study: <%= @study.name %></h1>
<div class="panel panel-primary">
	<div class="panel-heading">
		<div class="panel-title">
			<h4><%= link_to "Overview <span class='fa fa-chevron-down toggle-glyph'></span>".html_safe, '#overview', 'data-toggle' => 'collapse', class: 'white', id: 'study-overview'  %></h4>
		</div>
	</div>
	<div id="overview" class="panel-collapse collapse in">
		<div class="panel-body">
			<%= @study.description.html_safe %>
		</div>
	</div>
</div>
<div class="panel panel-primary">
	<div class="panel-heading">
		<div class="panel-title">
			<h4><%= link_to "<span class='fa fa-download'></span> Download #{@study.name} Data <span class='fa fa-chevron-right toggle-glyph'></span>".html_safe, '#files', 'data-toggle' => 'collapse', class: 'white', id: 'study-data-files'  %></h4>
		</div>
	</div>
	<div id="files" class="panel-collapse collapse">
		<div class="panel-body">
			<div class="table-responsive">
				<table class="table table-striped table-condensed">
					<thead>
					<tr>
						<th class="col-md-5">Filename</th>
						<th class="col-sm-6">Description</th>
						<th class="col-sm-1">Download</th>
					</tr>
					</thead>
					<tbody>
					<% @study.study_files.sort_by(&:name).each do |study_file| %>
						<tr>
							<td><%= study_file.name %></td>
							<td><%= study_file.description %></td>
							<td>
								<% if @study.embargoed?(current_user) %>
									<span class="label label-warning"><i class="fa fa-ban"></i> Not available until <%= @study.embargo.to_s(:long) %></span>
								<% else %>
									<%= render partial: '/layouts/download_link', locals: {study: @study, study_file: study_file} %>
								<% end %>
							</td>
						</tr>
					<% end %>
					</tbody>
				</table>
        <%= render partial: '/layouts/download_helper' %>
			</div>
		</div>
	</div>
</div>
<% if @study.initialized? %>
	<div class="row">
		<div class="col-md-3" id="search-target">
			<%= render partial: 'search_options' %>
		</div>
		<div class="col-md-9" id="render-target">
			<%= render partial: 'view_options' %>
			<div class="panel panel-default">
				<div class="panel-heading">
					<div class="panel-title">
						<h4><%= link_to "#{@study.name} Clusters <span class='fa fa-chevron-down toggle-glyph'></span>".html_safe, '#plots', 'data-toggle' => 'collapse' %></h4>
					</div>
				</div>
				<div id="plots" class="panel-collapse collapse in">
					<div class="panel-body">
						<div class="col-md-12">
							<div id="cluster-plot"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script type="text/javascript">

		<%= render partial: 'study_scatter_plot' %>

		// listener for cluster nav, specific to study page
		$("#cluster").change(function() {
			var url = '<%= render_cluster_path(study_name: params[:study_name]) %>';
			var target = document.getElementById('cluster-plot');
			var spinner = new Spinner(opts).spin(target);
			$(target).data('spinner', spinner);
			var cluster = $('#cluster').val();
			if (cluster == "") {
				$.get(url);
			} else {
				$.get(url + '?cluster=' + cluster);
			}
		});

		$( window ).on('resizeEnd', function() {
			<%= render 'study_scatter_layout' %>

			Plotly.newPlot('cluster-plot', data, layout);
		});

	</script>
<% end %>